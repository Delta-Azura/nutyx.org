<h1>Produire une ISO personalisée</h1>
 <div class="note"><img alt="[NOTE IMPORTANTE]" src="../graphics/note.gif"/>
  Toutes les commandes mentionnées dans cet article doivent se faire en root.
 </div>

 <h2>Intallation d'une NuTyX</h2>
  <h3>Assurez vous d'avoir installé les logiciels nécessaires</h3>
   <pre class="command"><kbd>cards install git cdrtools syslinux libisoburn dosfstools</kbd></pre>
  <h3>Récupérer les outils</h3>
   <pre class="command"><kbd>git clone https://github.com/NuTyX/packages-x86_64</kbd></pre>
  <h3>La variable indispensable pour la construction sera utilisée tout au long du processus</h3>
   <p>
    La variable LFS DOIT être définie.
   <pre class="command"><kbd>export LFS=/ISO-MINI</kbd></pre>
   <p>
    La chroot sera donc dans le dossier "/ISO-MINI".
    Libre à vous de choisir un autre dossier.
  <h3>Installer le système de base</h3>
   <pre class="command"><kbd>install-nutyx</kbd></pre>
  <h3>Copier les fichiers pour l'iso</h3>
   <pre class="command"><kbd>cp -av packages-x86_64/iso $LFS/ISO</kbd></pre>
  <h3>Entrer dans la chroot</h3>
   <pre class="command"><kbd>install-nutyx -ec</kbd></pre>
 <h2>Créer une NuTyX en fonction de ses besoins</h2>
  <h3>Note à propos des locales</h3>
   <p>
    Il n'est plus necessaire d'installer les locales, en effet
    la commande <b><i>cards upgrade</i></b> se chargera d'installer la locale définie lors de la post-configuration.
  <h3>Installer un kernel</h3>
   <p>
    Votre NuTyX necessite un kernel.
    Choisissez un kernel dans liste ci-dessous:
      <table>
     <caption>
     <EM>
      Liste des kernels.
     </EM>
     </caption>
     <tr class="sidebar">
      <th>
       Version du kernel
      <th>
       Nom du paquet à installer
     <tr class="even">
      <td>
       4.9.x
      <td>
       kernel-49
     <tr class="odd">
      <td>
       4.14.x
      <td>
       kernel-414
     <tr class="even">
      <td>
       4.19.x
      <td>
       kernel-419
     <tr class="odd">
      <td>
       5.4.x
      <td>
       kernel-54
     <tr class="even">
      <td>
       5.10.x
      <td>
       kernel-510
     <tr class="odd">
      <td>
       stable
      <td>
       kernel
    </table>
   <p>
    Par exemple, pour installer le kernel LTS 5.10:
    <pre class="command"><kbd>get kernel-510</kbd></pre>

  <h3>Mettre le kernel et l'initrd au bon endroit</h3>
   <pre class="command"><kbd>mkinitramfs $(basename /lib/modules/*) -nf</kbd></pre>

  <h3>Installer les systèmes d'initialisation</h3>
   <p>
    Votre NuTyX utilise systemV par défaut.
    Si vous souhaitez utiliser systemD ou runyx, il faut alors les installer.
    Au choix l'un ou l'autre ou les deux sont possible:
    <pre class="command"><kbd>get systemd runyx</kbd></pre>

  <h3>Installer les paquets pour un RAID</h3>
   <p>
    Si vous avez l'intention d'utiliser un RAID sur votre machine,
    installez le paquet:
    <pre class="command"><kbd>get mdadm</kbd></pre>

  <h3>Les firmwares</h3>
   <p>
    Si vous avez besoin de firmwares pour le bon fonctionnement de la machine.
    installer le paquet:
    <pre class="command"><kbd>get linux-firmware</kbd></pre>
   <p>
    Ce paquet contient plus de 2000 firmwares et necessite 500 Moctets d'espace sur le disque dur.

  <h3>Installer le paquet pour encrypter les partitions</h3>
   <p>
    Si vous souhaitez encrypter vos partitions, installez:
    <pre class="command"><kbd>get cryptsetup</kbd></pre>

  <h3>Service DHCP</h3>
   <p>
    Si vous n'avez pas l'intention d'installer le paquet network-manager et si vous ne souhaitez pas utiliser une adresse statique.
    Vous souhaitez donc vous connectez via un service DHCP depuis la console non graphique.
    Il faut alors installer le paquet dhcpcd:
    <pre class="command"><kbd>get dhcpcd</kbd></pre>

  <h3>Installer les paquets pour l'installation en EFI</h3>
   <p>
    Si votre machine supporte l'UEFI, ajoutez les paquets pour la gestion de celui-ci:
   <pre class="command"><kbd>get efibootmgr dosfstools</kbd></pre>

  <h3>Installer le support wifi</h3>
   <p>
    Si votre machine est capable de se connecter à un réseau sans fils,
    installez au moins les paquets suivants pour pouvoir en profiter:
   <pre class="command"><kbd>get wireless-tools wpa-supplicant</kb></pre>

  <h3>Support de la souris dans la console</h2>
   <p>
    Si vous souhaitez utiliser la souris dans la console, installez les paquets:
    <pre class="command"><kbd>get gpm gpm.service</kb></pre>

  <h3>Installer tous les paquets que vous souhaitez</h3>
   <pre class="command"><kbd>get mate firefox lightdm ...</kb></pre>

  <h3>Supprimer les archives des binaires</h3>
   <pre class="command"><kbd>cards purge</kbd></pre>

 <h2>Génération de l'iso</h2>
  <h3>Générer les fichiers squashfs</h3>
   <pre class="command"><kbd>for dir in opt bin etc lib lib64 root run sbin usr var home
do
  [ -f /ISO/boot/$dir.squashfs ] && rm /ISO/boot/$dir.squashfs
  mksquashfs /$dir /ISO/boot/$dir.squashfs
done</kbd></pre>
  <h3>Quitter NuTyX chroot</h3>
   <pre class="command"><kbd>exit</kbd></pre>
  <h3>Générer l'ISO</h3>
   <pre class="command"><kbd>bash packages-x86_64/scripts/mkiso $(basename $LFS) $(basename $LFS/lib/modules/*)</kbd></pre>
 <h2>Créer une clé USB amorçable</h2>
  <p>
    Insérer une clé USB et vérifer son emplacement avec la commande:
    <pre class="command"><kbd>lsblk -S</kbd></pre>
  <pre class="output">NAME HCTL       TYPE VENDOR   MODEL                 REV SERIAL           TRAN
sda  0:0:0:0    disk ...
sdb  2:0:0:0    disk ...
sdc  8:0:0:0    disk TDKMedia Trans-It_Drive       PMAP 07991E033A9CAF0E usb</pre>
  <p>
   Transférer l'image ISO sur la clé trouvée via la commande ci-dessus (remplacer sdX avec votre clé USB)
 <div class="important"><img alt="[Important]" src="../graphics/caution.gif" >
   La commande qui suit va supprimer toutes les données qui se trouvent sur la clé.
  </div>
   <pre class="command"><kbd>dd if=$LFS/NuTyX_x86_64-ISO-MINI.iso of=/dev/sdX status=progress
sync</kbd></pre>
 <h2>Conclusion</h2>
  <p>
   La taille de l'iso ne devrait pas dépasser 500 MB si vous n'avez rien ajouté de plus que les paquets ci-dessus.
   Vous la trouverez dans le dossier $LFS.
   <pre class="command"><kbd>ls $LFS</kbd></pre>
   <pre class="output">bin   dev  home  lib  NuTyX_x86_64-ISO-MINI.iso     proc  run   srv  tmp  var
boot  etc  ISO   mnt  NuTyX_x86_64-20190626.md5sum  root  sbin  sys  usr</pre>
